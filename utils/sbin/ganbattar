#!/usr/bin/env ruby
#
# named by "Yoshihiro Ura <support@fuuzu.net>" - https://github.com/kyubuns/

class Header
  def initialize(header)
    raise "magic mismatch" unless header[257, 5] == 'ustar'

    @name = header[0, 100].rstrip
      .gsub(/[^[:print:]]/) {|m| '#'}
      .gsub(/\//, '+')
      .gsub(/^\./, '_')
    @size = header[124, 12].oct
    @type = header[156]
  end

  def name() @name end
  def size() @size end
  def type() @type end
end

File.open(ARGV[0], 'rb') {|inb|
  block = nil
  prev = nil
  while true
    prev = block
    block = inb.read(512)
    break if block == nil

    i = block.index("ustar")

    next if i == nil

    if i != 257
      puts "info: Index of magic mismatched, try to reindexing..."
      inb.seek(-(512 + 257 - i), IO::SEEK_CUR)
      next
    end

    h = Header.new(block)
    File.open(h.name, 'wb') {|outb|
      done = outb.write(inb.read(h.size))
      puts "written #{h.name}"
      puts "   warning: #{h.size} bytes expected but written #{done} bytes..." if h.size != done
    }
  end
}
